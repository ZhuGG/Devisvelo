<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Extracteur de pi√®ces ‚Äì Devis v√©lo (PDF)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050609;
      --bg-elevated: #12141d;
      --bg-elevated-soft: rgba(18, 20, 29, 0.88);
      --accent: #ffbf3c;
      --accent-soft: rgba(255, 191, 60, 0.14);
      --accent-strong: #ff9f1c;
      --text-main: #f5f5f4;
      --text-muted: #a1a1aa;
      --border-subtle: #27272f;
      --danger: #f97373;
      --radius-lg: 18px;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.55);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #181823 0, #050609 55%);
      color: var(--text-main);
    }

    body {
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 24px;
    }

    .app-shell {
      width: 100%;
      max-width: 1200px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 16px 20px;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: linear-gradient(
          120deg,
          rgba(255, 191, 60, 0.18),
          transparent 40%,
          rgba(255, 159, 28, 0.16)
        ),
        linear-gradient(145deg, #161824, #050609);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(18px);
    }

    header h1 {
      margin: 0;
      font-size: 1.3rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    header .subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    header .badge {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: rgba(0, 0, 0, 0.45);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    header .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--accent-strong);
      box-shadow: 0 0 8px var(--accent-strong);
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.7fr);
      gap: 18px;
    }

    @media (max-width: 900px) {
      body {
        padding: 16px;
      }

      main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      position: relative;
      padding: 18px 20px 20px;
      background: var(--bg-elevated-soft);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(
          circle at top left,
          rgba(255, 191, 60, 0.08),
          transparent 55%
        ),
        radial-gradient(
          circle at bottom right,
          rgba(255, 191, 60, 0.03),
          transparent 60%
        );
      mix-blend-mode: screen;
      opacity: 0.7;
    }

    .card-content {
      position: relative;
      z-index: 1;
    }

    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .card-kicker {
      font-size: 0.75rem;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .card-description {
      font-size: 0.83rem;
      color: var(--text-muted);
      margin-bottom: 14px;
    }

    .drop-zone {
      border-radius: 16px;
      border: 1px dashed rgba(250, 250, 249, 0.24);
      background: radial-gradient(
          circle at top,
          rgba(255, 191, 60, 0.12),
          transparent 55%
        ),
        rgba(5, 6, 9, 0.74);
      padding: 18px 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: border-color 0.18s ease, background 0.18s ease,
        transform 0.08s ease;
    }

    .drop-zone.is-dragover {
      border-color: var(--accent);
      background: radial-gradient(
          circle at top,
          rgba(255, 191, 60, 0.24),
          transparent 55%
        ),
        rgba(5, 6, 9, 0.9);
      transform: translateY(-1px);
    }

    .drop-icon {
      width: 38px;
      height: 38px;
      border-radius: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-soft);
      border: 1px solid rgba(255, 191, 60, 0.5);
      box-shadow: 0 0 15px rgba(255, 191, 60, 0.45);
      font-size: 1.35rem;
    }

    .drop-title {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .drop-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: center;
    }

    .file-input {
      display: none;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      padding: 7px 14px;
      font-size: 0.8rem;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      cursor: pointer;
      background: linear-gradient(
        135deg,
        rgba(255, 191, 60, 0.16),
        rgba(255, 191, 60, 0.32)
      );
      color: var(--text-main);
      font-weight: 500;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      transition: background 0.12s ease, transform 0.08s ease,
        box-shadow 0.12s ease;
      box-shadow: 0 10px 25px rgba(255, 191, 60, 0.22);
    }

    .btn:hover {
      background: linear-gradient(
        135deg,
        rgba(255, 191, 60, 0.23),
        rgba(255, 191, 60, 0.42)
      );
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(255, 191, 60, 0.26);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: rgba(12, 12, 16, 0.8);
      box-shadow: none;
      border-color: rgba(255, 255, 255, 0.12);
    }

    .btn-secondary:hover {
      background: rgba(24, 24, 32, 0.9);
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.55);
    }

    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      font-size: 0.78rem;
    }

    .stat-pill {
      padding: 5px 8px;
      border-radius: 999px;
      background: rgba(12, 12, 16, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.06);
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .stat-pill span.value {
      color: var(--accent);
      font-weight: 500;
    }

    .results-wrapper {
      max-height: 330px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(5, 6, 9, 0.8);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      margin-top: 6px;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 1;
      background: linear-gradient(
        to bottom,
        #161824,
        rgba(22, 24, 36, 0.95)
      );
    }

    th,
    td {
      text-align: left;
      padding: 7px 8px;
    }

    th {
      font-size: 0.78rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      border-bottom: 1px solid rgba(255, 255, 255, 0.12);
    }

    td {
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }

    tbody tr:hover {
      background: rgba(255, 191, 60, 0.05);
    }

    .qty-cell {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .empty-state {
      margin-top: 20px;
      padding: 14px 12px;
      border-radius: 12px;
      border: 1px dashed rgba(255, 255, 255, 0.14);
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .toast {
      position: fixed;
      right: 18px;
      bottom: 18px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(8, 47, 73, 0.95);
      color: #e0f2fe;
      font-size: 0.78rem;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 16px 35px rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(125, 211, 252, 0.6);
      backdrop-filter: blur(12px);
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: opacity 0.16s ease, transform 0.16s ease;
      z-index: 1000;
    }

    .toast.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .toast-danger {
      background: rgba(127, 29, 29, 0.96);
      border-color: rgba(248, 113, 113, 0.8);
      color: #fee2e2;
    }

    footer {
      margin-top: 4px;
      font-size: 0.72rem;
      color: var(--text-muted);
      text-align: right;
    }

    canvas {
      width: 100%;
      max-height: 260px;
      object-fit: contain;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: #0b0d12;
    }

    .preview-caption {
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div>
        <h1>Extracteur de pi√®ces ‚Äî devis v√©lo (PDF)</h1>
        <p class="subtitle">
          D√©pose un PDF contenant un ou plusieurs devis. L‚Äôanalyse reste locale dans ton navigateur.
        </p>
      </div>
      <div class="badge">
        <span class="badge-dot"></span>
        <span>Local ‚Ä¢ Offline</span>
      </div>
    </header>

    <main>
      <section class="card">
        <div class="card-content">
          <div class="card-header">
            <div>
              <div class="card-kicker">√âtape 1</div>
              <div class="card-title">D√©poser le PDF de devis</div>
            </div>
          </div>
          <p class="card-description">
            Format attendu : tableau <strong>ARTICLES / QT√â / PU / TVA / TOTAL</strong> comme dans ton exemple.
            Chaque ligne d‚Äôarticle peut avoir une ou plusieurs lignes de description, suivies d‚Äôune ligne chiffr√©e.
          </p>

          <label class="drop-zone" id="dropZone">
            <div class="drop-icon">üìÑ</div>
            <div class="drop-title">Glisse ton fichier PDF ici</div>
            <div class="drop-subtitle">
              ou clique pour le s√©lectionner<br />
              <span style="font-size: 0.75rem; opacity: 0.8">
                Un seul PDF √† la fois (plusieurs pages possibles).
              </span>
            </div>
            <button type="button" class="btn btn-secondary" id="browseButton">
              Parcourir‚Ä¶
            </button>
            <input
              type="file"
              class="file-input"
              id="fileInput"
              accept="application/pdf"
            />
          </label>

          <div style="margin-top: 14px;">
            <canvas id="previewCanvas"></canvas>
            <div class="preview-caption">
              Aper√ßu de la premi√®re page pour v√©rifier que tu as le bon document.
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-content">
          <div class="card-header" style="margin-bottom: 6px;">
            <div>
              <div class="card-kicker">√âtape 2</div>
              <div class="card-title">R√©capitulatif des pi√®ces extraites</div>
            </div>
            <button class="btn" id="exportButton" disabled>
              Exporter en CSV
            </button>
          </div>
          <p class="card-description">
            L‚Äôalgorithme rep√®re le bloc <strong>ARTICLES / QT√â / PU / TVA / TOTAL</strong>,
            reconstruit la description d‚Äôarticle et additionne les quantit√©s sur l‚Äôensemble du PDF.
          </p>

          <div class="stats-row" id="statsRow" style="display:none;">
            <div class="stat-pill">
              Pages analys√©es :
              <span class="value" id="statPages">0</span>
            </div>
            <div class="stat-pill">
              Lignes trouv√©es :
              <span class="value" id="statRows">0</span>
            </div>
            <div class="stat-pill">
              Articles uniques :
              <span class="value" id="statItems">0</span>
            </div>
          </div>

          <div id="resultsContainer">
            <div class="empty-state" id="emptyState">
              Aucun PDF analys√© pour le moment.<br />
              Commence par d√©poser un devis √† gauche.
            </div>

            <div class="results-wrapper" id="resultsWrapper" style="display: none;">
              <table>
                <thead>
                  <tr>
                    <th>Article</th>
                    <th style="text-align:right;">Quantit√© totale</th>
                  </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      v1 ‚Äî Lecture PDF c√¥t√© client avec PDF.js. Pens√© pour les devis type Ateliers de l‚Äôaudace.
    </footer>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Script principal (module ES) -->
  <script type="module">
    // On importe PDF.js via CDN (version 5.x √† la date de r√©daction).
    // Si un jour √ßa casse, mettre √† jour la version dans l‚ÄôURL.
    import * as pdfjsLib from "https://unpkg.com/pdfjs-dist@5.4.394/build/pdf.min.mjs";

    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://unpkg.com/pdfjs-dist@5.4.394/build/pdf.worker.min.mjs";

    const dropZone = document.getElementById("dropZone");
    const browseButton = document.getElementById("browseButton");
    const fileInput = document.getElementById("fileInput");
    const previewCanvas = document.getElementById("previewCanvas");
    const exportButton = document.getElementById("exportButton");
    const statsRow = document.getElementById("statsRow");
    const statPages = document.getElementById("statPages");
    const statRows = document.getElementById("statRows");
    const statItems = document.getElementById("statItems");
    const emptyState = document.getElementById("emptyState");
    const resultsWrapper = document.getElementById("resultsWrapper");
    const resultsBody = document.getElementById("resultsBody");
    const toastEl = document.getElementById("toast");

    let aggregated = new Map();
    let totalRows = 0;
    let pagesAnalyzed = 0;

    function showToast(message, isError = false) {
      toastEl.textContent = message;
      toastEl.classList.toggle("toast-danger", isError);
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 2800);
    }

    function resetAll() {
      aggregated.clear();
      totalRows = 0;
      pagesAnalyzed = 0;
      statPages.textContent = "0";
      statRows.textContent = "0";
      statItems.textContent = "0";
      statsRow.style.display = "none";
      emptyState.style.display = "block";
      resultsWrapper.style.display = "none";
      resultsBody.innerHTML = "";
      exportButton.disabled = true;

      const ctx = previewCanvas.getContext("2d");
      ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
    }

    function normalizeText(str) {
      return str
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase();
    }

    function isTableHeaderLine(line) {
      const norm = normalizeText(line);
      return norm.includes("articles") && norm.includes("qte") && norm.includes("total");
    }

    function isTableEndLine(line) {
      const norm = normalizeText(line);
      return (
        norm.includes("total ht") ||
        norm.includes("solde total") ||
        norm.includes("taux de tva")
      );
    }

    // Ligne du type "1 8,00 0% 8,00"
    function parseQuantityLine(line) {
      const trimmed = line.trim();
      const match = trimmed.match(
        /^(\d+)\s+([\d.,]+)\s+(\d+%)\s+([\d.,]+)\s*$/
      );
      if (!match) return null;
      const qty = parseInt(match[1], 10);
      if (!qty || Number.isNaN(qty)) return null;
      return { qty };
    }

    function renderStats() {
      if (pagesAnalyzed === 0) {
        statsRow.style.display = "none";
        return;
      }
      statsRow.style.display = "flex";
      statPages.textContent = String(pagesAnalyzed);
      statRows.textContent = String(totalRows);
      statItems.textContent = String(aggregated.size);
    }

    function renderResults() {
      if (aggregated.size === 0) {
        emptyState.style.display = "block";
        resultsWrapper.style.display = "none";
        exportButton.disabled = true;
        return;
      }
      emptyState.style.display = "none";
      resultsWrapper.style.display = "block";
      exportButton.disabled = false;

      const entries = Array.from(aggregated.entries()).sort((a, b) => {
        if (b[1] !== a[1]) return b[1] - a[1]; // tri qty desc
        return a[0].localeCompare(b[0], "fr");
      });

      resultsBody.innerHTML = "";
      for (const [article, qty] of entries) {
        const tr = document.createElement("tr");
        const tdName = document.createElement("td");
        const tdQty = document.createElement("td");
        tdName.textContent = article;
        tdQty.textContent = qty.toLocaleString("fr-FR");
        tdQty.className = "qty-cell";
        tr.appendChild(tdName);
        tr.appendChild(tdQty);
        resultsBody.appendChild(tr);
      }
    }

    function exportCsv() {
      if (aggregated.size === 0) return;
      const lines = ["designation,quantite_totale"];
      for (const [article, qty] of aggregated.entries()) {
        const safeArticle = '"' + article.replace(/"/g, '""') + '"';
        lines.push(`${safeArticle},${qty.toString().replace(".", ",")}`);
      }
      const blob = new Blob([lines.join("\n")], {
        type: "text/csv;charset=utf-8;",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const date = new Date().toISOString().slice(0, 10);
      a.href = url;
      a.download = `pieces_devis_agregees_${date}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast("CSV export√©.");
    }

    async function renderPreview(pdf) {
      try {
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 1.2 });
        const canvas = previewCanvas;
        const context = canvas.getContext("2d");
        const ratio = window.devicePixelRatio || 1;

        canvas.width = viewport.width * ratio;
        canvas.height = viewport.height * ratio;
        canvas.style.height = "260px";
        canvas.style.width = "100%";

        const scale = (canvas.height / ratio) / viewport.height;
        const vp = page.getViewport({ scale });

        const renderContext = {
          canvasContext: context,
          viewport: vp,
        };
        await page.render(renderContext).promise;
      } catch (e) {
        console.error(e);
      }
    }

    // Reconstruit des lignes textuelles √† partir de textContent.items
    function buildLinesFromTextContent(textContent) {
      const lines = [];
      let currentLine = "";
      for (const item of textContent.items) {
        if (!item.str) continue;
        const text = item.str;
        currentLine += (currentLine ? " " : "") + text;
        if (item.hasEOL) {
          lines.push(currentLine.trim());
          currentLine = "";
        }
      }
      if (currentLine.trim()) {
        lines.push(currentLine.trim());
      }
      return lines;
    }

    // Analyse textuelle page par page
    async function analyzePdf(arrayBuffer) {
      resetAll();
      const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
      const pdf = await loadingTask.promise;

      pagesAnalyzed = pdf.numPages;

      // Aper√ßu
      renderPreview(pdf);

      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const textContent = await page.getTextContent();
        const lines = buildLinesFromTextContent(textContent);

        let inTable = false;
        let descBuffer = [];

        for (const rawLine of lines) {
          const line = rawLine.trim();
          if (!line) continue;

          if (!inTable) {
            if (isTableHeaderLine(line)) {
              inTable = true;
              descBuffer = [];
            }
            continue;
          }

          if (isTableEndLine(line)) {
            inTable = false;
            descBuffer = [];
            continue;
          }

          const qtyInfo = parseQuantityLine(line);
          if (qtyInfo) {
            const description = descBuffer.join(" ").replace(/\s+/g, " ").trim();
            descBuffer = [];
            if (!description) continue;
            const key = description;
            const prev = aggregated.get(key) || 0;
            aggregated.set(key, prev + qtyInfo.qty);
            totalRows += 1;
          } else {
            descBuffer.push(line);
          }
        }
      }

      renderStats();
      renderResults();

      if (aggregated.size === 0) {
        showToast(
          "Aucune ligne d‚Äôarticles d√©tect√©e. V√©rifie le format du devis.",
          true
        );
      } else {
        showToast("Analyse PDF termin√©e.");
      }
    }

    async function handleFile(file) {
      if (!file) return;
      if (file.type !== "application/pdf") {
        showToast("Merci de s√©lectionner un PDF.", true);
        return;
      }
      try {
        const arrayBuffer = await file.arrayBuffer();
        await analyzePdf(arrayBuffer);
      } catch (e) {
        console.error(e);
        showToast("Erreur lors de la lecture du PDF.", true);
      }
    }

    // UI events
    browseButton.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      handleFile(file);
    });

    ["dragenter", "dragover"].forEach((eventName) => {
      dropZone.addEventListener(
        eventName,
        (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.add("is-dragover");
        },
        false
      );
    });

    ["dragleave", "drop"].forEach((eventName) => {
      dropZone.addEventListener(
        eventName,
        (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.remove("is-dragover");
        },
        false
      );
    });

    dropZone.addEventListener("drop", (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files.length > 1) {
        showToast("Un seul PDF √† la fois, je prends le premier.");
      }
      handleFile(files[0]);
    });

    exportButton.addEventListener("click", exportCsv);
  </script>
</body>
</html>
