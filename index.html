<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Extracteur de pi√®ces ‚Äì Devis v√©lo (PDF)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/css/main.css" />
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="brand">
        <img src="logo.webp" alt="Devis V√©lo" class="brand-logo" />
        <div class="brand-text">
          <h1>Extracteur de pi√®ces ‚Äî devis v√©lo (PDF)</h1>
          <p class="subtitle">
            D√©pose un PDF contenant un ou plusieurs devis. L‚Äôanalyse reste locale dans ton navigateur.
          </p>
        </div>
      </div>
      <div class="badge">
        <span class="badge-dot"></span>
        <span>Local ‚Ä¢ Offline</span>
      </div>
    </header>

    <main>
      <section class="card">
        <div class="card-content">
          <div class="card-header">
            <div>
              <div class="card-kicker">√âtape 1</div>
              <div class="card-title">D√©poser le PDF de devis</div>
            </div>
          </div>
          <p class="card-description">
            Format attendu : tableau <strong>ARTICLES / QT√â / PU / TVA / TOTAL</strong> comme dans ton exemple.
            Chaque ligne d‚Äôarticle peut avoir une ou plusieurs lignes de description, suivies d‚Äôune ligne chiffr√©e.
          </p>

          <label class="drop-zone" id="dropZone">
            <div class="drop-icon">üìÑ</div>
            <div class="drop-title">Glisse ton fichier PDF ici</div>
            <div class="drop-subtitle">
              ou clique pour le s√©lectionner<br />
              <span class="drop-subtitle-note">
                Un seul PDF √† la fois (plusieurs pages possibles).
              </span>
            </div>
            <button type="button" class="btn btn-secondary" id="browseButton">
              Parcourir‚Ä¶
            </button>
            <input
              type="file"
              class="file-input"
              id="fileInput"
              accept="application/pdf"
            />
          </label>

          <div class="preview-wrapper">
            <canvas id="previewCanvas"></canvas>
            <div class="preview-caption">
              Aper√ßu de la premi√®re page pour v√©rifier que tu as le bon document.
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-content">
          <div class="card-header card-header--spaced">
            <div>
              <div class="card-kicker">√âtape 2</div>
              <div class="card-title">R√©capitulatif des pi√®ces extraites</div>
            </div>
            <button class="btn" id="exportButton" disabled>
              Exporter en CSV
            </button>
          </div>
          <p class="card-description">
            L‚Äôalgorithme rep√®re le bloc <strong>ARTICLES / QT√â / PU / TVA / TOTAL</strong>,
            reconstruit la description d‚Äôarticle et additionne les quantit√©s sur l‚Äôensemble du PDF.
          </p>

          <div class="stats-row" id="statsRow">
            <div class="stat-pill">
              Pages analys√©es :
              <span class="value" id="statPages">0</span>
            </div>
            <div class="stat-pill">
              Lignes trouv√©es :
              <span class="value" id="statRows">0</span>
            </div>
            <div class="stat-pill">
              Articles uniques :
              <span class="value" id="statItems">0</span>
            </div>
          </div>

          <div id="resultsContainer">
            <div class="empty-state" id="emptyState">
              Aucun PDF analys√© pour le moment.<br />
              Commence par d√©poser un devis √† gauche.
            </div>

            <div class="results-wrapper" id="resultsWrapper">
              <table>
                <thead>
                  <tr>
                    <th>Article</th>
                    <th class="qty-header">Quantit√© totale</th>
                  </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      v1 ‚Äî Lecture PDF c√¥t√© client avec PDF.js. Pens√© pour les devis type Ateliers de l‚Äôaudace.
    </footer>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import * as pdfjsLib from "https://unpkg.com/pdfjs-dist@5.4.394/build/pdf.min.mjs";
    import {
      elements,
      showToast,
      resetUi,
      renderPreview,
      renderResults,
      renderStats,
    } from "./assets/js/ui.js";

    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://unpkg.com/pdfjs-dist@5.4.394/build/pdf.worker.min.mjs";

    const state = {
      aggregated: new Map(),
      totalRows: 0,
      pagesAnalyzed: 0,
    };

    function normalizeText(str) {
      return str
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase();
    }

    function isTableHeaderLine(line) {
      const norm = normalizeText(line);
      return norm.includes("articles") && norm.includes("qte") && norm.includes("total");
    }

    function isTableEndLine(line) {
      const norm = normalizeText(line);
      return (
        norm.includes("total ht") ||
        norm.includes("solde total") ||
        norm.includes("taux de tva")
      );
    }

    function sanitizeNumber(rawValue) {
      if (!rawValue) {
        return NaN;
      }
      return Number.parseFloat(
        rawValue
          .replace(/‚Ç¨/gi, "")
          .replace(/ttc/gi, "")
          .replace(/eur/gi, "")
          .replace(/\s+/g, "")
          .replace(/,/g, "."),
      );
    }

    function pushLine(lines, parts) {
      if (!parts || parts.length === 0) {
        return;
      }
      const joined = parts.join(" ").replace(/\s+/g, " ").trim();
      if (joined) {
        lines.push(joined);
      }
      parts.length = 0;
    }

    function buildLinesFromTextContent(textContent) {
      const lines = [];
      let currentParts = [];
      let currentBaseline = null;

      for (const item of textContent.items) {
        if (!item.str) {
          continue;
        }

        const text = item.str.replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
        if (!text) {
          continue;
        }

        const baseline = item.transform ? item.transform[5] : null;
        const height = item.height || (item.transform ? Math.abs(item.transform[3]) : 0);
        const tolerance = Math.max(2, (height || 9) * 0.6);

        if (currentBaseline === null && baseline !== null) {
          currentBaseline = baseline;
        }

        if (
          currentParts.length > 0 &&
          baseline !== null &&
          currentBaseline !== null &&
          Math.abs(baseline - currentBaseline) > tolerance
        ) {
          pushLine(lines, currentParts);
          currentBaseline = baseline;
        }

        currentParts.push(text);

        if (item.hasEOL) {
          pushLine(lines, currentParts);
          currentBaseline = null;
        }
      }

      pushLine(lines, currentParts);
      return lines;
    }

    function parseQuantityLine(line) {
      let rest = line.replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
      if (!rest) {
        return null;
      }

      const totalMatch = rest.match(
        /(?<total>(?:\d[\d\s.,]*\d|\d)(?:\s?(?:‚Ç¨|eur|ttc|‚Ç¨ttc))?)$/i,
      );
      if (!totalMatch) {
        return null;
      }
      rest = rest.slice(0, -totalMatch[0].length).trim();

      const tvaMatch = rest.match(
        /(?<tva>(?:\d[\d\s.,]*\s*%?)|-|exon[√©e]r[√©e])$/i,
      );
      if (!tvaMatch) {
        return null;
      }
      rest = rest.slice(0, -tvaMatch[0].length).trim();

      const unitMatch = rest.match(/(?<unit>(?:\d[\d\s.,]*\d|\d)(?:\s?(?:‚Ç¨|eur))?)$/i);
      if (!unitMatch) {
        return null;
      }
      rest = rest.slice(0, -unitMatch[0].length).trim();

      const qtyMatch = rest.match(/(?<qty>\d[\d\s.,]*)$/);
      if (!qtyMatch) {
        return null;
      }
      rest = rest.slice(0, -qtyMatch[0].length).trim();

      const qty = sanitizeNumber(qtyMatch.groups.qty);
      if (!Number.isFinite(qty) || qty <= 0) {
        return null;
      }

      const description = rest.replace(/\s+/g, " ").trim();
      if (description) {
        return { qty, description };
      }

      return { qty };
    }

    function resetAnalysis() {
      state.aggregated.clear();
      state.totalRows = 0;
      state.pagesAnalyzed = 0;
      resetUi();
    }

    async function analyzePdf(arrayBuffer) {
      if (!arrayBuffer) {
        return;
      }

      resetAnalysis();

      const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
      const pdf = await loadingTask.promise;

      state.pagesAnalyzed = pdf.numPages;

      await renderPreview(pdf);

      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum += 1) {
        const page = await pdf.getPage(pageNum);
        const textContent = await page.getTextContent();
        const lines = buildLinesFromTextContent(textContent);

        let inTable = false;
        let descBuffer = [];

        for (const rawLine of lines) {
          const line = rawLine.trim();
          if (!line) {
            continue;
          }

          if (!inTable) {
            if (isTableHeaderLine(line)) {
              inTable = true;
              descBuffer = [];
            }
            continue;
          }

          if (isTableEndLine(line)) {
            inTable = false;
            descBuffer = [];
            continue;
          }

          const qtyInfo = parseQuantityLine(line);
          if (qtyInfo) {
            let description = descBuffer.join(" ").replace(/\s+/g, " ").trim();
            descBuffer = [];
            if (qtyInfo.description) {
              description = qtyInfo.description;
            }
            if (!description) {
              continue;
            }
            const previousValue = state.aggregated.get(description) || 0;
            state.aggregated.set(description, previousValue + qtyInfo.qty);
            state.totalRows += 1;
          } else {
            descBuffer.push(line);
          }
        }
      }

      renderStats({
        pagesAnalyzed: state.pagesAnalyzed,
        totalRows: state.totalRows,
        uniqueArticles: state.aggregated.size,
      });
      renderResults(state.aggregated);

      if (state.aggregated.size === 0) {
        showToast("Aucune ligne d‚Äôarticles d√©tect√©e. V√©rifie le format du devis.", true);
      } else {
        showToast("Analyse PDF termin√©e.");
      }

      return {
        pagesAnalyzed: state.pagesAnalyzed,
        totalRows: state.totalRows,
        aggregated: new Map(state.aggregated),
      };
    }

    function buildCsvContent() {
      if (state.aggregated.size === 0) {
        return null;
      }

      const entries = Array.from(state.aggregated.entries()).sort((a, b) => {
        if (b[1] !== a[1]) {
          return b[1] - a[1];
        }
        return a[0].localeCompare(b[0], "fr");
      });

      const lines = ["designation,quantite_totale"];
      for (const [article, qty] of entries) {
        const safeArticle = '"' + article.replace(/"/g, '""') + '"';
        lines.push(`${safeArticle},${qty.toString().replace(".", ",")}`);
      }
      return lines.join("\n");
    }

    const { dropZone, browseButton, fileInput, exportButton } = elements;

    async function handleFile(file) {
      if (!file) {
        return;
      }

      if (file.type !== "application/pdf") {
        showToast("Merci de s√©lectionner un PDF.", true);
        return;
      }

      try {
        const arrayBuffer = await file.arrayBuffer();
        await analyzePdf(arrayBuffer);
      } catch (error) {
        console.error(error);
        showToast("Erreur lors de la lecture du PDF.", true);
      } finally {
        fileInput.value = "";
      }
    }

    function exportCsv() {
      const csvContent = buildCsvContent();
      if (!csvContent) {
        return;
      }

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const date = new Date().toISOString().slice(0, 10);
      a.href = url;
      a.download = `pieces_devis_agregees_${date}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast("CSV export√©.");
    }

    browseButton.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", (event) => {
      const [file] = event.target.files;
      handleFile(file);
    });

    ["dragenter", "dragover"].forEach((eventName) => {
      dropZone.addEventListener(
        eventName,
        (event) => {
          event.preventDefault();
          event.stopPropagation();
          dropZone.classList.add("is-dragover");
        },
        false,
      );
    });

    ["dragleave", "drop"].forEach((eventName) => {
      dropZone.addEventListener(
        eventName,
        (event) => {
          event.preventDefault();
          event.stopPropagation();
          dropZone.classList.remove("is-dragover");
        },
        false,
      );
    });

    dropZone.addEventListener("drop", (event) => {
      const { files } = event.dataTransfer;
      if (!files || files.length === 0) {
        return;
      }
      if (files.length > 1) {
        showToast("Un seul PDF √† la fois, je prends le premier.");
      }
      handleFile(files[0]);
    });

    exportButton.addEventListener("click", exportCsv);
  </script>
</body>
</html>
